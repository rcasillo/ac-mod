name: Update Release Index

on:
  release:
    types: [published]
  workflow_dispatch:  # Allow manual updates

permissions:
  contents: write

jobs:
  update-index:
    name: Update RELEASES.md
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Generate release index
        run: |
          # Fetch all releases using GitHub API
          gh release list --limit 1000 --json tagName,name,publishedAt > releases.json

          # Process releases with Python for better JSON handling
          python3 .github/scripts/process_releases.py > RELEASES.md

          cat RELEASES.md
        env:
          GH_TOKEN: ${{ github.token }}
          GITHUB_REPOSITORY: ${{ github.repository }}

      - name: Update README with new cars
        run: |
          # Find all car directories and check if they're in README
          python3 .github/scripts/update_readme.py

      - name: Commit and push changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add RELEASES.md README.md

          # Only commit if there are changes
          if git diff --staged --quiet; then
            echo "No changes to commit"
            exit 0
          fi

          # Commit the changes
          git commit -m "Update release index and README [skip ci]"

          # Fetch latest changes and handle conflicts
          git fetch origin main

          # Try to rebase
          if ! git rebase origin/main; then
            echo "⚠️  Rebase conflict detected. Regenerating files from latest main..."

            # Abort the failed rebase
            git rebase --abort

            # Checkout latest main
            git checkout origin/main

            # Re-run the generation scripts on fresh main
            gh release list --limit 1000 --json tagName,name,publishedAt > releases.json
            python3 .github/scripts/process_releases.py > RELEASES.md
            python3 .github/scripts/update_readme.py

            # Commit the regenerated files
            git checkout -b temp-update-branch
            git add RELEASES.md README.md
            git commit -m "Update release index and README [skip ci]" || echo "No changes after regeneration"

            # Force push to main (safe because these are generated files)
            git push origin temp-update-branch:main
          else
            # Rebase succeeded, push normally
            git push origin HEAD:main
          fi
        env:
          GH_TOKEN: ${{ github.token }}
          GITHUB_REPOSITORY: ${{ github.repository }}
